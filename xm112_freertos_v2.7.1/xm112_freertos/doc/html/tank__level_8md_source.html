<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Acconeer SDK: /home/ai/jenkins/workspace/sw-main/doc/user_guides/ref_app/tank_level.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 66px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('tank__level_8md.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/ai/jenkins/workspace/sw-main/doc/user_guides/ref_app/tank_level.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="tank__level_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# Tank Level {#tank_level}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;## Source Code</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;ref_app_tank_level.c</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;## Description</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;The tank level reference application shows how the Acconeer&#39;s Distance Detector can be used to measure the fluid level in a tank by measuring the distance in three sectors (close, mid, and far). The application will measure the distance from the sensor to the fluid surface. If the height of the tank is known, the distance to the water surface can be used to calculate the fluid level from the bottom of the tank. Using this formula:</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;```</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;fluid_level = height_of_tank - distance_to_surface</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;```</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;The application uses different configurations to optimize for the specific range. The first range is measuring very close to the sensor (-0.11 to 0.12 m) and utilizes recorded threshold to filter out the direct leakage and static objects in the tank. Since the close range is measuring in the range of direct leakage, the distance measurement will be less accurate than beyond the direct leakage. Also, it only measures if there are any sample points above the threshold and reports the distance to the first sample point above the threshold. This will make the distance measurement less accurate and it should be used to detect if the surface is inside the close range or not, rather than measuring the actual distance.</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;![Detection withing the close range](close-range-detection.png)</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;If no surface is detected in the first sector, the application measures in the mid range (0.1 to 0.47 m). The mid range also utilizes recorded threshold to filter out static objects. In this sector, it is possible to measure the distance to the surface accurately compared to the close range.</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;![Detection within the mid range](mid-range-detection.png)</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;When recording the background of the close and mid range, the fluid level must be outside the range, i.e. further away than 0.47 m from the sensor. Otherwise, the water might not be detected accurately since it will be part of the recorded background.</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;For larger tanks (height &gt;0.5 m), the far range (0.19 to 1.49 m) will be used when the fluid level is beyond the mid range sector. The far range utilizes Constant False Alarm Rate (CFAR) threshold to accurately detect the distance to the fluid level. The CFAR threshold will require no background recording, which means it uses less memory but might detect static objects.</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;![No detection withing the far range. Bottom of tank at ~0.8 m and floor at ~1.1 m](far-range-no-detection.png)</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;One measurement for the application consists of the distance detector measuring these three ranges. If a peak is detected, the ranges further out are skipped. This is to avoid strong double reflections.</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;To limit the measurement update rate, a call to a sleep function can be added after the far range measurement (a comment in the source code advises where to add a call to a sleep function). If there is a long time between measurements in the application, the sensor should be recalibrated before starting a measurement using the sensor_calibration function. The sensor needs to be recalibrated to account for changes in the surrounding environment.</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;## Configuration</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;As mentioned above, the Tank Level reference application uses the Acconeer Distance Detector, see [Read-the-Docs](https://acconeer-python-exploration.readthedocs.io/en/latest/processing/distance_detector.html) for a detailed description and acc_detector_distance.h for the API. The Distance Detector is built on top of the Envelope Service, see [Read-the-Docs](https://acconeer-python-exploration.readthedocs.io/en/latest/services/envelope.html) for a detailed description and acc_service_envelope.h for the API.</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;To be able to easier test similar use cases using the RSS API or the [Python Exploration Tool](https://github.com/acconeer/acconeer-python-exploration), the configuration used in the Reference Application can be seen in the tables below.</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;| **Service Parameter**          | **Close** | **Mid**   | **Far**   |</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;|--------------------------------|-----------|-----------|-----------|</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;| running_average_factor         | 0.0       | 0.0       | 0.0       |</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;| asynchronous_measurement       | true      | true      | true      |</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;| downsampling_factor            | 1         | 1         | 4         |</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;| gain*                          | 0.32      | 0.5       | 0.82      |</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;| hw_accelerated_average_samples | 10        | 10        | 10        |</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;| maximize_signal_attenuation    | true      | false     | false     |</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;| noise_level_normalization      | true      | true      | true      |</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;| power_save_mode                | ready     | ready     | ready     |</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;| profile                        | 1         | 1         | 2         |</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;| start                          | -0.11     | 0.10      | 0.19      |</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;| length                         | 0.23      | 0.37      | 1.30      |</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;| end                            | 0.12      | 0.47      | 1.49      |</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;| repetition_mode                | On Demand | On Demand | On Demand |</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;| tx_disable                     | false     | false     | false     |</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;| **Distance Detector Parameter**      | **Close** | **Mid**   | **Far**   |</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;|--------------------------------------|-----------|-----------|-----------|</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;| threshold_type                       | Rec       | Rec       | CFAR      |</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;| sweep_averaging                      | 30        | 30        | 10        |</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;| record_background_sweeps             | 30        | 30        | CFAR      |</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;| threshold_sensitivity                | 0.2       | 0.2       | 0.4       |</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;| cfar_threshold_window                | n/a       | n/a       | 0.03      |</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;| cfar_threshold_guard                 | n/a       | n/a       | 0.12      |</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;| cfar_threshold_only_lower_distance   | n/a       | n/a       | False     |</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;| peak_sorting_type                    | strongest | strongest | strongest |</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;| measurement_sample_above_threshold** | true      | false     | false     |</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;*Note that this is the initial gain used in the Reference Application, but then it can be changed depending on if the data saturates.</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;**Note that this is not a configuration for the Detector, but rather a result that is used instead of the standard distance result.</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;## Testing</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;### Test setup</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;The reference application is tested using a plastic water tank. The volume of the tank is 220 liters and the height is 0.785 m and the diameter 0.67 m. It is set up according to the images below using an XM132 module and LH132 with an FZP lens in the outermost position (D2). The FZP lens is attached directly to the lid with double-sided tape. See [Getting Started Guide Lenses](https://developer.acconeer.com/download/getting-started-guide-lenses-pdf/) for more information about lenses and performance.</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;![Tank setup](tank-level-setup.jpg)</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;![XM132 setup on tank](tank-level-XM132-setup.jpg)</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;### Test execution</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;The test was performed by measuring the water level while filling and emptying the tank. First, the backgrounds for the close and mid range are recorded while the tank is empty. Then, water is filled until the water level is just beneath the lens and the water is let out again.</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;### Test results</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;The empty tank is ~0.8 m. Since the tap on the tank was ~0.05 m from the bottom of the tank, it is not completely emptied during testing.</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;Table: Memory Usage for Reference Application Tank Level on XM132.</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;|               | Memory Usage [kB] |</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;|---------------|:-----------------:|</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;| Flash         | 82                |</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;| Static memory | 12                |</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;| Stack         | 2                 |</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;| Heap          | 14                |</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;Table: Power Consumption for Reference Application Tank Level on XM132. The power consumption of the reference application will depend on the integration and the actual application. For example, the power consumption will depend on the fluid level since only the close range will be executed if the fluid level is detected within the close range. Also, these numbers are for active measurements, sleeping in the application, and thereby decreasing the measurement rate, will lower the total power consumption of the application.</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;| Range | Mean current [mA] | Voltage [V] | Power [mW] | Average execution time [ms] | Power consumption [mWs] |</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;|-------|:-----------------:|:-----------:|:----------:|:---------------------------:|:-----------------------:|</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;| Close | 44                | 1.8         | 79         | 620                         | 49                      |</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;| Mid   | 44                | 1.8         | 79         | 1000                        | 79                      |</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;| Far   | 44                | 1.8         | 79         | 270                         | 21                      |</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;#### Result</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;![Filling and emptying tank](tank-level-filling-and-emptying.png)</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;The graph shows how the water surface gets closer to the sensor when the tank is filled. It is clear to see that the surface reaches the close range at 0.12 m and the characteristics of the line changes. The distance accuracy is not as good when measuring in the close range since the measurement is affected by the direct leakage and the close range measures the distance to the first sample point above threshold rather than the distance to the center of a peak.</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;## Limitations</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;There are limitations to the tank level application. The sensor calibration can fail if the water surface is too close to the sensor during sensor calibration. This is an issue if the sensor is re-calibrated between measurements due to a long time between measurements.</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;If the lens becomes wet because of liquid touching the lens or because of condensation, the measurement can become faulty since the lens will become visible to the sensor.</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
</div>
</body>
</html>
